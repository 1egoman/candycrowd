<!-- footer -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjForTCddy3tS81cvKcxUoyDvxUVdtKY0&callback=initMap"></script>
<script>
  google_api_key = "AIzaSyBjForTCddy3tS81cvKcxUoyDvxUVdtKY0"
  var map

  // generate differing sized candy icons
  var candy_pin = []
  for (i = 1; i <= 10; i++) {
    candy_pin.push({
      path: 'M 125,5 155,90 245,90 175,145 200,230 125,180 50,230 75,145 5,90 95,90 z',
      fillColor: 'yellow',
      fillOpacity: 0.8,
      scale: 0.03 * i,
      strokeColor: 'gold',
      strokeWeight: 2
    })
  }

  // google map init
  function initMap() {
    navigator.geolocation.getCurrentPosition(function(geo) {
      map = new google.maps.Map(document.getElementById('map'), {
      center: {
        lat: geo.coords.latitude,
        lng: geo.coords.longitude
      },
        zoom: 18
      });
    })
  }


  // reset map center to the current location
  reset_map_center = function() {
    navigator.geolocation.getCurrentPosition(function(geo) {
      map.panTo({
        lat: geo.coords.latitude,
        lng: geo.coords.longitude
      })
    })
  }
  setInterval(reset_map_center, 1000)



  var socket = io()
  socket.on("new:house:ack", function(p) {
    console.log("Got a response: "+JSON.stringify(p))
    get_houses()
  })

  socket.on("get:house:ack", function(h) {
    setTimeout(function() {
      $(".house-container").html(JSON.stringify(h, null, 2))

      h.forEach(function(house) {
        marker = new google.maps.Marker({
          position: house,
          map: map,
          title: house.rating.toString(),
          icon: candy_pin[Math.floor(house.rating)]
        });

        marker.addListener('click', function() {
          alert(house.rating);
        });
      })
    }, 1000)
  })

  // add a new house with the current location
  add_new_house = function(rating) {
    navigator.geolocation.getCurrentPosition(function(coords) {
      socket.emit("new:house", {
        rating: rating,
        lat: coords.coords.latitude,
        lng: coords.coords.longitude
      })
    })
  }

  get_houses = function() {
    socket.emit("get:house")
  }

  new_house = function() {
    add_new_house(parseInt($(".ratings-box").val()))
  }
  get_houses()
</script>
