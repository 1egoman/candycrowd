<!-- footer -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjForTCddy3tS81cvKcxUoyDvxUVdtKY0"></script>
<script>
  var map, us_location, types = [], all_houses = []

  // generate differing sized candy icons
  var candy_pin = []
  for (i = 1; i <= 11; i++) {
    candy_pin.push({
      path: 'M12.8,9.1C11.6,13.4,7,31,7,31S2.4,13.5,1.3,9.1C0.2,4.7,2.2,1,7,1S13.7,5.2,12.8,9.1z',
      fillColor: '#db9019',
      fillOpacity: 1,
      scale: 0.2 * i,
      strokeColor: '#c6c6c6',
      strokeWeight: 0,
      anchor: {x: 8, y: 30}
    })
  }

  // icon for an inactive house
  var inactive = {
    path: 'M 125,5 155,90 245,90 175,145 200,230 125,180 50,230 75,145 5,90 95,90 z',
    fillColor: 'red',
    fillOpacity: 1,
    scale: 0.1,
    strokeColor: 'red',
    strokeWeight: 2,
    anchor: {x: 8, y: 30}
  }


  // the icon for the user
  var user = {
    path: 'M64.8,38.2c0,5.3,5.6,26.2,3.9,30.5c-2.3,5.7-5.9,0.2-10.6-0.3c-4.8-0.5-10.5,2.8-15.2,2.8c-4,0-7.7-4.7-12.1-3.5c-5.5,1.5-9.9,6-12.2,0.8c-2-4.4-2.4-25-2.4-30.4c0-16.9,10.9-30.5,24.3-30.5S64.8,21.4,64.8,38.2z',
    fillColor: 'white',
    fillOpacity: 1,
    scale: 0.5,
    strokeColor: 'black',
    strokeWeight: 2,
    anchor: {x: 40, y: 30}
  }









  // google map init
  function initialize() {
    console.log("loading google maps...")
    navigator.geolocation.getCurrentPosition(function(geo) {
      console.log("we're at", geo.coords)

      // create the google map
      map = new google.maps.Map(document.getElementById('map'), {
      center: {
        lat: geo.coords.latitude,
        lng: geo.coords.longitude
      },
        zoom: 18
      });
    })
    setTimeout(get_houses, 1000)
  }
  google.maps.event.addDomListener(window, 'load', initialize);

  // reset our location on the map every second
  reset_map_center = function(pos) {
    console.log(pos)
    navigator.geolocation.getCurrentPosition(function(geo) {
      us_location && us_location.setMap(null)
      us_location = new google.maps.Marker({
        position: {
          lat: geo.coords.latitude,
          lng: geo.coords.longitude
        },
        map: map,
        icon: user
      })
    })
  }
  navigator.geolocation.watchPosition(reset_map_center)


  open_rate_view = function() {
    $(".blurred-bg").css("display", "block")
    $(".rate-view").css("display", "block")
  }

  close_rate_view = function() {
    $(".blurred-bg").css("display", "none")
    $(".rate-view").css("display", "none")
  }

  is_old = function(i) {
    HOUR = 60 * 60 * 1000
    current = new Date().getTime()
    return i.last_updated + HOUR < current
  }



  var socket = io()
  socket.on("new:house:ack", function(p) {
    console.log("Got a response: "+JSON.stringify(p))
    get_houses()
  })

  // update houses on the map
  socket.on("get:house:ack", function(h) {
    /* $(".house-container").html(JSON.stringify(h, null, 2)) */
    /* console.log(h) */

    // clear all houses
    all_houses.forEach(function(i){ i.setMap(null)  })

    h.forEach(function(house) {
      marker = new google.maps.Marker({
        position: house,
        map: map,
        title: house.rating.toString(),
        icon: is_old(house) ? inactive : candy_pin[Math.floor(house.rating)]
      });

      marker.addListener('click', function() {
        alert(house.types.join(", "));
      });
      all_houses.push(marker)
    })
  })

  // add a new house with the current location
  add_new_house = function(rating, type) {
    navigator.geolocation.getCurrentPosition(function(coords) {
      socket.emit("new:house", {
        rating: rating,
        types: types,
        lat: coords.coords.latitude,
        lng: coords.coords.longitude
      })
    })
  }

  get_houses = function() {
    socket.emit("get:house")
  }

  new_house = function() {
    add_new_house(parseInt($(".ratings-box").val()), types)
    $(".main-view").css("display", "block")
    $(".rate-view").css("display", "none")
    $(".blurred-bg").css("display", "none")
  }

</script>
